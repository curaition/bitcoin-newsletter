{
  "$schema": "https://schema.railpack.com",
  "provider": "python",
  "packages": {
    "python": "3.11"
  },
  "buildAptPackages": [
    "git",
    "curl"
  ],
  "caches": {
    "pip": {
      "directory": "/root/.cache/pip",
      "type": "shared"
    },
    "uv": {
      "directory": "/root/.cache/uv", 
      "type": "shared"
    }
  },
  "steps": {
    "install": {
      "commands": [
        "pip install uv",
        "uv sync --frozen"
      ],
      "caches": ["pip", "uv"]
    },
    "setup-django": {
      "inputs": [
        { "step": "install" }
      ],
      "commands": [
        "python scripts/setup_beat_database.py migrate"
      ]
    },
    "web": {
      "inputs": [
        { "step": "setup-django" }
      ],
      "commands": [
        "echo 'Web service ready'"
      ],
      "deployOutputs": ["."]
    },
    "worker": {
      "inputs": [
        { "step": "setup-django" }
      ],
      "commands": [
        "echo 'Worker service ready'"
      ],
      "deployOutputs": ["."]
    },
    "beat": {
      "inputs": [
        { "step": "setup-django" }
      ],
      "commands": [
        "python scripts/setup_beat_database.py create-tasks"
      ],
      "deployOutputs": ["."]
    }
  },
  "deploy": {
    "base": {
      "image": "python:3.11-slim"
    },
    "inputs": [
      "...",
      { "step": "${SERVICE_TYPE:-web}" }
    ],
    "startCommand": "${START_COMMAND}",
    "variables": {
      "PYTHONPATH": "/app/src"
    }
  }
}
