services:
  # Main FastAPI Web Service
  - type: web
    name: bitcoin-newsletter-api
    runtime: python
    region: oregon
    plan: starter
    buildCommand: |
      python -m pip install --upgrade pip
      pip install -e .
    startCommand: "crypto-newsletter serve --production --host 0.0.0.0 --port $PORT"
    envVars:
      - key: DATABASE_URL
        value: "postgresql+asyncpg://neondb_owner:npg_prKBLEUJ1f8P@ep-purple-firefly-ab009z0a-pooler.eu-west-2.aws.neon.tech/neondb"
      - key: REDIS_URL
        fromService:
          type: redis
          name: bitcoin-newsletter-redis
          property: connectionString

      - key: ENVIRONMENT
        value: "production"
      - key: SERVICE_TYPE
        value: "web"
      - key: LOG_LEVEL
        value: "INFO"
      - key: DEBUG
        value: "false"
      - key: ENABLE_CELERY
        value: "true"
      - key: PYTHONPATH
        value: "/opt/render/project/repo/src"
      # AI/ML API Keys (sensitive - set via Render dashboard)
      - key: GEMINI_API_KEY
        sync: false  # Set manually in Render dashboard
      - key: TAVILY_API_KEY
        sync: false  # Set manually in Render dashboard
      # Agent Model Configuration (non-sensitive)
      - key: CONTENT_ANALYSIS_AGENT_MODEL
        value: "gemini-2.5-flash"
      - key: SIGNAL_VALIDATION_AGENT_MODEL
        value: "gemini-2.5-flash"
      - key: NEWSLETTER_GENERATION_AGENT_MODEL
        value: "gemini-2.5-flash"
      - key: CROSS_ARTICLE_ANALYSIS_AGENT_MODEL
        value: "gemini-2.5-flash"
      - key: TREND_DETECTION_AGENT_MODEL
        value: "gemini-2.5-flash"
      # Analysis Configuration (non-sensitive)
      - key: ANALYSIS_DAILY_BUDGET
        value: "15.00"
      - key: ANALYSIS_MAX_COST_PER_ARTICLE
        value: "0.25"
      - key: ANALYSIS_MIN_CONTENT_LENGTH
        value: "2000"
    healthCheckPath: "/health"

  # Celery Worker Service
  - type: worker
    name: bitcoin-newsletter-worker
    runtime: python
    region: oregon
    plan: starter
    buildCommand: |
      python -m pip install --upgrade pip
      pip install -e .
    startCommand: "crypto-newsletter worker"
    envVars:
      - key: DATABASE_URL
        value: "postgresql+asyncpg://neondb_owner:npg_prKBLEUJ1f8P@ep-purple-firefly-ab009z0a-pooler.eu-west-2.aws.neon.tech/neondb"
      - key: REDIS_URL
        fromService:
          type: redis
          name: bitcoin-newsletter-redis
          property: connectionString

      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: bitcoin-newsletter-redis
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: redis
          name: bitcoin-newsletter-redis
          property: connectionString
      - key: ENVIRONMENT
        value: "production"
      - key: SERVICE_TYPE
        value: "worker"
      - key: LOG_LEVEL
        value: "INFO"
      - key: DEBUG
        value: "false"
      - key: ENABLE_CELERY
        value: "true"
      - key: PYTHONPATH
        value: "/opt/render/project/repo/src"
      # Agent Model Configuration (non-sensitive)
      - key: CONTENT_ANALYSIS_AGENT_MODEL
        value: "gemini-2.5-flash"
      - key: SIGNAL_VALIDATION_AGENT_MODEL
        value: "gemini-2.5-flash"
      # Analysis Configuration (non-sensitive)
      - key: ANALYSIS_DAILY_BUDGET
        value: "15.00"
      - key: ANALYSIS_MAX_COST_PER_ARTICLE
        value: "0.25"
      - key: ANALYSIS_MIN_CONTENT_LENGTH
        value: "2000"
      # Agent Model Configuration
      - key: CONTENT_ANALYSIS_AGENT_MODEL
        value: "gemini-2.5-flash"
      - key: SIGNAL_VALIDATION_AGENT_MODEL
        value: "gemini-2.5-flash"
      # Analysis Configuration
      - key: ANALYSIS_DAILY_BUDGET
        value: "15.00"
      - key: ANALYSIS_MAX_COST_PER_ARTICLE
        value: "0.25"
      - key: ANALYSIS_MIN_CONTENT_LENGTH
        value: "2000"

  # Celery Beat Scheduler Service
  - type: worker
    name: bitcoin-newsletter-beat
    runtime: python
    region: oregon
    plan: starter
    buildCommand: |
      python -m pip install --upgrade pip
      pip install -e .
    startCommand: "crypto-newsletter beat"
    envVars:
      - key: DATABASE_URL
        value: "postgresql+asyncpg://neondb_owner:npg_prKBLEUJ1f8P@ep-purple-firefly-ab009z0a-pooler.eu-west-2.aws.neon.tech/neondb"
      - key: REDIS_URL
        fromService:
          type: redis
          name: bitcoin-newsletter-redis
          property: connectionString

      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: bitcoin-newsletter-redis
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: redis
          name: bitcoin-newsletter-redis
          property: connectionString
      - key: ENVIRONMENT
        value: "production"
      - key: SERVICE_TYPE
        value: "beat"
      - key: LOG_LEVEL
        value: "INFO"
      - key: DEBUG
        value: "false"
      - key: ENABLE_CELERY
        value: "true"
      - key: PYTHONPATH
        value: "/opt/render/project/repo/src"
      # Agent Model Configuration (non-sensitive)
      - key: CONTENT_ANALYSIS_AGENT_MODEL
        value: "gemini-2.5-flash"
      - key: SIGNAL_VALIDATION_AGENT_MODEL
        value: "gemini-2.5-flash"
      # Analysis Configuration (non-sensitive)
      - key: ANALYSIS_DAILY_BUDGET
        value: "15.00"
      - key: ANALYSIS_MAX_COST_PER_ARTICLE
        value: "0.25"
      - key: ANALYSIS_MIN_CONTENT_LENGTH
        value: "2000"

  # Redis service for Celery (PostgreSQL hosted externally on Neon)
  - type: redis
    name: bitcoin-newsletter-redis
    region: oregon
    plan: starter
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []  # Allow access from all Render services in this account

# Frontend Services
  # Admin Dashboard (React)
  - type: web
    name: bitcoin-newsletter-admin
    runtime: node
    region: oregon
    plan: starter
    buildCommand: |
      cd admin-dashboard
      npm install
      npm install -g serve
      npm run build
    startCommand: "cd admin-dashboard && serve -s dist -l $PORT"
    envVars:
      - key: VITE_API_URL
        value: "https://bitcoin-newsletter-api.onrender.com"
      - key: VITE_APP_ENV
        value: "production"
      - key: VITE_APP_VERSION
        value: "1.0.0"
      - key: VITE_ENABLE_MOCK_AUTH
        value: "true"
    healthCheckPath: "/"
